## 锁机制

### 全局锁

全局锁是对整个数据库实例加锁。

```
flush tables with read lock
```

给整个库加上全局读锁，之后其它线程涉及到表结构变化，修改数据，更新事务提交等操作都会阻塞。

备份数据库的三种方式:

1. 全局锁

全局读锁主要应用在全库逻辑备份，为了让备份得到的库保持在同一个逻辑时间点，可以用加锁的方式，但是会引发下面两个问题：

* 对于主库的加锁备份，在备份期间数据库都不能更新，业务就会停摆
* 对于从库的加锁备份，期间从库不能执行主库同步过来的binlog，导致主从延迟。

2. 设置隔离级别

在存储引擎层设置事务的隔离级别为可重复读，也可以让备份的库保持在同一逻辑时间点。

用 mysqldump + single-transaction 备份数据，在导数据之前就会启动事务，确保拿到一致性视图。
而MVCC的支持也可以保证备份过程中数据可以正常更新。

所以对于支持事务引擎的库，使用 single-transaction 备份数据库更合适，但是并非所有存储引擎都支持事务，所以更推荐使用innodb作为存储引擎。

3. 全局变量readonly

设置全库只读还有一种方式：设置全局变量 readonly
```
set global readonly=true
```
这种方式也可以让全库只读，但是会有如下两个影响：

* 在有些系统中判断主备数据库的依据就是readonly的值，全局变量的设置会带来混乱
* 使用全局锁的时候当客户端发生异常时mysql会自动释放锁，但是设置全局变量以后如果客户端发生错误数据库会一直保持只读状态，需要手动修改全局变量，影响业务，风险较高。


